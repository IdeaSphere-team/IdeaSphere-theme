/**
 * ICENTERÁºñËæëÂô®
 * @DEV JASON
 */

async function getCSRFToken() {
    const response = await fetch('/api/csrf-token');
    const data = await response.json();
    return data.csrf_token;
}

/**
 * ÊûÑÂª∫ÂèØËßÜÂåñÁõÆÂΩïÊ†ë
 */
function build_tree(tree_object) {
    // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
    const container = document.getElementById('file-tree-container');
    container.innerHTML = '';

    // ÈÄíÂΩíÂàõÂª∫Ê†ëËäÇÁÇπÔºà‰øÆÂ§çÁº©ËøõÈóÆÈ¢òÔºâ
    const createTreeElement = (node, depth = 0) => {
        const nodeDiv = document.createElement('div');
        nodeDiv.style.marginLeft = depth * 15 + 'px'; // Ê†πÊçÆÂ±ÇÁ∫ßÂä®ÊÄÅÁº©Ëøõ

        // ÂõæÊ†áÂíåÂêçÁß∞
        const icon = document.createElement('span');
        icon.innerHTML = node.type === 'directory' ? 'üìÅ' : 'üìÑ';
        icon.style.cursor = 'pointer';
        icon.className = 'file-tree-icon';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = node.name;
        nameSpan.className = `file-tree-node ${node.type}`;
        nameSpan.style.marginLeft = '5px';
        nameSpan.style.userSelect = 'none';

        // ÁõÆÂΩïÊ†∑Âºè
        if (node.type === 'directory') {
            const arrow = document.createElement('span');
            arrow.className = 'file-tree-arrow';
            arrow.textContent = '‚ñº';
            nameSpan.insertAdjacentElement('afterbegin', arrow);
        }

        if (node.type === 'file') {
            nameSpan.style.cursor = 'pointer';
            nameSpan.addEventListener('click', async (e) => {
                e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                handleFileClick(node); // ÊâßË°åËá™ÂÆö‰πâÊñá‰ª∂Â§ÑÁêÜ
            });
        }

        nodeDiv.append(icon, nameSpan);

        // Â§ÑÁêÜÂ≠êËäÇÁÇπ
        if (node.children?.length) {
            const childList = document.createElement('ul');
            childList.style.listStyle = 'none';
            childList.style.paddingLeft = '0'; // ÁßªÈô§Âõ∫ÂÆöÁº©Ëøõ

            node.children.sort((a, b) => {
                if (a.type === b.type) {
                    return a.name.localeCompare(b.name)
                }
                return a.type === 'directory' ? -1 : 1
            })
                .forEach(child => {
                    const li = document.createElement('li')
                    li.appendChild(createTreeElement(child, depth + 1))
                    childList.appendChild(li)
                })

            nodeDiv.appendChild(childList);
        }

        return nodeDiv;
    };

    container.appendChild(createTreeElement(tree_object));

    // Â±ïÂºÄ/ÊäòÂè†ÂäüËÉΩÔºà‰øÆÂ§çÈÄâÊã©Âô®Ôºâ
    container.addEventListener('click', (e) => {
        const arrow = e.target.closest('.file-tree-node.directory')?.querySelector('.file-tree-arrow');
        if (arrow) {
            const ul = arrow.closest('div').querySelector('ul');
            if (ul) {
                const isCollapsed = ul.style.display === 'none';
                ul.style.display = isCollapsed ? 'block' : 'none';
                arrow.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
            }
        }
    });
}


async function handleFileClick(fileNode) {
    try {
        const csrfToken = await getCSRFToken();
        const response = await fetch('/get_file_content', {
            method: 'POST',
            headers: {
                'X-CSRF-Token': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                filename: fileNode.name,
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const ext = fileNode.name.split('.').pop();
                    buildEditor(data.content, ext, fileNode.name); // ‰º†ÈÄíÊñá‰ª∂Êâ©Â±ïÂêç
                }
            })
    } catch (e) {
        showError(`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${e.message}`)
        throw e
    }
}

/**
 * ÂàùÂßãÂåñÁºñËæëÂô®
 */
document.addEventListener('DOMContentLoaded', async () => {
    // Âä®ÊÄÅÊ∑ªÂä†Ê†∑Âºè
    const style = document.createElement('style');
    style.textContent = `
        #file-tree {
            font-family: 'Consolas', monospace;
            font-size: 14px;
        }
        #file-tree span.directory {
            cursor: pointer;
            transition: background 0.2s;
        }
        #file-tree span.directory:hover {
            background: #f5f5f5;
        }
        #file-tree span.file {
            color: #666;
        }
        .arrow {
            display: inline-block;
            width: 15px;
        }
    `;
    document.head.appendChild(style);

    // Ëé∑ÂèñÁõÆÂΩïÊï∞ÊçÆ
    try {
        const csrfToken = await getCSRFToken();
        const response = await fetch('/directory_tree_api', {
            method: 'GET',
            headers: {
                'X-CSRF-Token': csrfToken,
                'Content-Type': 'application/json',
            }
        });

        const data = await response.json();
        if (data.success) {
            build_tree(data.tree);
        } else {
            showError(data.error || 'Êú™Áü•ÈîôËØØ');
        }
    } catch (error) {
        showError(`ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•: ${error.message}`);
    }
});

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.style.color = '#ff4444';
    errorDiv.style.padding = '10px';
    errorDiv.textContent = `ÈîôËØØÔºö${message}`;
    document.body.prepend(errorDiv);
    console.error('Error:', message);
}


async function buildEditor(code, fileExt, fileName) {
    if (!fileName) {
        fileName = prompt('ËØ∑ËæìÂÖ•Êñá‰ª∂Âêç') || `newfile.${lang}`;
    }
    const pos_to_editor_main = document.getElementById('editor-main');
    pos_to_editor_main.innerHTML = '';
    // Ê†πÊçÆÊâ©Â±ïÂêçËÆæÁΩÆËØ≠Ë®Ä
    const languages = {
        js: 'javascript',
        py: 'python',
        html: 'html',
        css: 'css'
    };
    const lang = languages[fileExt] || 'plaintext';
    // ÂàõÂª∫ÂÆπÂô®ÂíåÂ∑•ÂÖ∑Ê†è
    const container = document.createElement('div');
    container.className = 'editor-container';

    // Ê∑ªÂä†Â∑•ÂÖ∑Ê†è
    const toolbar = document.createElement('div');
    toolbar.className = 'editor-toolbar';
    const saveBtn = document.createElement('button');
    saveBtn.textContent = 'üíæ ‰øùÂ≠ò';
    toolbar.appendChild(saveBtn);
    container.appendChild(toolbar);

    // ÂàõÂª∫ÁºñËæëÂå∫Âüü
    const editorWrapper = document.createElement('div');
    editorWrapper.className = 'editor-wrapper';

    // ÂàùÂßãÂåñÊï∞ÊçÆ
    let allLines = code ? code.split(/\r?\n/) : [];
    let modifiedLines = [...allLines];
    const pageSize = 100;
    let isLoading = false;
    let loadedLines = new Set(); // Êñ∞Â¢ûÔºöËÆ∞ÂΩïÂ∑≤Âä†ËΩΩË°åÂè∑
    let lastScrollPos = 0; // Êñ∞Â¢ûÔºöËÆ∞ÂΩï‰∏äÊ¨°ÊªöÂä®‰ΩçÁΩÆ

    // ÂàõÂª∫ÁºñËæëÂÖÉÁ¥†ÔºàÊ∑ªÂä†Ë°åÊ†áËØÜÔºâ
    const createEditorLine = (index, content) => {
        const lineDiv = document.createElement('div');
        lineDiv.className = 'editor-line';

        // Ë°åÂè∑‰øùÊåÅ‰∏çÂèò
        const lineNumber = document.createElement('span');
        lineNumber.className = 'line-number';
        lineNumber.textContent = index + 1;

        // ÊõøÊç¢‰∏∫ÊîØÊåÅÈ´ò‰∫ÆÁöÑ‰ª£Á†ÅÂùó
        const codeContainer = document.createElement('div');
        codeContainer.className = 'code-container';

        const pre = document.createElement('pre');
        const codeElem = document.createElement('code');
        codeElem.className = `language-${lang}`;
        codeElem.textContent = content;
        codeElem.contentEditable = true; // ‰øùÊåÅÂèØÁºñËæë

        // Ê∑ªÂä†È´ò‰∫Æ
        hljs.highlightElement(codeElem);

        // ËæìÂÖ•‰∫ã‰ª∂Â§ÑÁêÜ
        codeElem.addEventListener('input', (e) => {
            modifiedLines[index] = e.target.textContent;
            // ËæìÂÖ•ÂêéÈáçÊñ∞È´ò‰∫Æ
            hljs.highlightElement(codeElem);
        });

        pre.appendChild(codeElem);
        codeContainer.appendChild(pre);
        lineDiv.append(lineNumber, codeContainer);

        return lineDiv;
    };

    // Ê∑ªÂä†CSSÊ†∑ÂºèÔºàËøΩÂä†Âà∞Â∑≤ÊúâÊ†∑Âºè‰∏≠Ôºâ
    const highlightStyle = `        .hljs{background:#f8f8f8;padding:0.3em}
        .code-container {flex-grow:1}
        .editor-line {
            display: flex;
            margin: 2px 0;
            align-items: start;
        }
        pre {
            margin:0;
            padding:0;
            background:none !important;
        }
        code {
            white-space: pre-wrap;
            display: block;
            padding-left: 5px;
        }
    `;
    document.head.querySelector('style').textContent += highlightStyle;

    // ÊîπËøõÁöÑÂä†ËΩΩÂáΩÊï∞ÔºàÂ¢ûÈáèÂä†ËΩΩÔºâ
    const loadLines = (start, end) => {
        const fragment = document.createDocumentFragment();
        for (let i = start; i < end; i++) {
            if (i >= modifiedLines.length) break;
            if (!loadedLines.has(i)) {
                fragment.appendChild(createEditorLine(i, modifiedLines[i]));
                loadedLines.add(i);
            }
        }
        editorWrapper.appendChild(fragment);
    };

    // ‰øùÂ≠òÂäüËÉΩÔºà‰øùÊåÅ‰∏çÂèòÔºâ
    saveBtn.addEventListener('click', async () => {
        try {
            const csrfToken = await getCSRFToken();
            const response = await fetch('/save_file', {
                method: 'POST',
                headers: {
                    'X-CSRF-Token': csrfToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: modifiedLines.join('\n'),
                    filename: fileName || 'untitled'
                })
            });
            // console.log(modifiedLines.join('\n'))
            // console.log(fileName)
            const result = await response.json();
            if (result.success) {
                alert('‰øùÂ≠òÊàêÂäü');
                allLines = [...modifiedLines];
            }
        } catch (e) {
            showError(`‰øùÂ≠òÂ§±Ë¥•: ${e.message}`);
        }
    });

    // ÊîπËøõÁöÑÊªöÂä®Â§ÑÁêÜÈÄªËæë
    let currentStart = 0;
    const handleScroll = () => {
        if (isLoading) return;

        const {scrollTop, scrollHeight, clientHeight} = editorWrapper;
        const scrollDirection = scrollTop > lastScrollPos ? 'down' : 'up';
        lastScrollPos = scrollTop;

        // Âêë‰∏ãÊªöÂä®Âä†ËΩΩ
        if (scrollDirection === 'down' && (scrollTop + clientHeight >= scrollHeight - 100)) {
            isLoading = true;
            const newEnd = Math.min(currentStart + pageSize, allLines.length);
            loadLines(currentStart, newEnd);
            currentStart = newEnd;
            isLoading = false;
        }
        // Âêë‰∏äÊªöÂä®Âä†ËΩΩ
        else if (scrollDirection === 'up' && scrollTop <= 100) {
            isLoading = true;
            const newStart = Math.max(0, currentStart - pageSize * 2);
            loadLines(newStart, currentStart);
            currentStart = newStart;
            isLoading = false;
        }
    };

    // ÂàùÂßãÂåñÂä†ËΩΩ
    loadLines(0, pageSize);
    currentStart = pageSize;

    // Ê∑ªÂä†ÊªöÂä®‰∫ã‰ª∂
    editorWrapper.addEventListener('scroll', handleScroll);
    container.appendChild(editorWrapper);
    pos_to_editor_main.appendChild(container);
}
